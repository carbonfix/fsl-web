<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
	"http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>IP VLAN</title>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link href="include/css_en_imx28x.css" rel="stylesheet" type="text/css" />
        <script language="javascript" type="text/javascript" src="js/msg_mw_en.js"></script>
        <script language="javascript" type="text/javascript" src="js/linux_en_imx28x.js"></script>
        <script language="javascript" type="text/javascript" src="js/func.js"></script>
		<script language="JavaScript" type="text/javascript" src="js/func_ex.js"></script>
		<script language="JavaScript">
			var count = 0;

			function init()
			{
				var cf = document.forms[0];
				var t = 0, b = 0, i = 0, tmp, n = 0, a = 0;
				var ip_vlan = new Array();
				var ports = cf.port_bits.value;
				var gPorts = cf.g_port_bits.value;
				var strPort;
				
				show_language_flag();
				ip_vlan = cf.h_ip_vlan.value.split(";");
				
				for(i == 0; i < ip_vlan.length -1; i++)
					list_add_ip_vlan(0, ip_vlan[i]);

				set_ip_vlan_port();
				
				if(cf.loader.value != "admin")
					disable_all_intput();
			}

			function additem()
			{
				var cf = document.forms[0];
				var msg = "";
				var port_maps = 0;
				var i, n = 0;
				var flag = false;
				var overwrite_vlan = 0;
                var checkval = new Array();
                
                var addip = cf.ip_address.value.split("/")[0];
                var addmask = cf.ip_address.value.split("/")[1];

				if(!check_vlan_ip(addip))
					msg += msg_incorrect_ip;
				else if(!(addmask >= 0 && addmask <= 32))
					msg += "IP address mask range is adnormal.\n";

				if(cf.ip_vlan_port_list.value == -1)
					msg += msg_no_select_port;

				msg += checkInt(cf.ip_vlan_vid, "VID", 1, 4094, true);

				if(msg != "")
					return checkMsg(msg);
				

				for(i = 1; i < cf.ip_vlan_table.options.length; i++)
				{
					if(cf.ip_address.value.split("/")[0] == cf.ip_vlan_table.options[i].value.split(":")[0] && 
						cf.ip_address.value.split("/")[1] == cf.ip_vlan_table.options[i].value.split(":")[1] &&
						cf.ip_vlan_port_list.value == cf.ip_vlan_table.options[i].value.split(":")[2] )
					{
						flag = confirm("VLAN record already exists,overwrite it?");
						if(flag == true)
						{
							overwrite_vlan = i;
							break;
						}
						else
							return false;
					}
				}
				
				if(!overwrite_vlan)
				{
					if(cf.ip_vlan_table.options.length-1 >= 100)
						msg += "Supports the configuration of up to 100 IP VLAN.\n"

					if(msg != "")
						return checkMsg(msg);
				}
				
				list_add_ip_vlan(overwrite_vlan, cf.ip_address.value.split("/")[0] + ":" + cf.ip_address.value.split("/")[1] + ":" + cf.ip_vlan_port_list.value + ":" + cf.ip_vlan_vid.value);

				cf.ip_address.value = "";
				cf.ip_vlan_port_list.value = 0;
				cf.ip_vlan_vid.value = "";

			}

			function list_add_ip_vlan(overwrite_vlan, ip_vlan)
			{
				var cf = document.forms[0];
				var ip_vlan_tem = ip_vlan.split(":");
				var tem = "";
				var ports = cf.port_bits.value;
                var port_map_array = cf.port_map.value.split(";");
				
				if(0 == overwrite_vlan)
					tmp = "-"+ (count+1);
				else
					tmp = "-"+ (overwrite_vlan);

				for(i = fucCheckLength(tmp); i < 7; i++)
					tmp += "-";
				if(i == 7)
					tmp += "-------------------";

				tmp += ip_vlan_tem[0] + "/" + ip_vlan_tem[1];
				for(i = ip_vlan_tem[0].length + ip_vlan_tem[1].length; i < 17; i++)
					tmp += "-";
				tmp +="----------------------------";

				//port
				if(ports & (1<<ip_vlan_tem[2]))
				{
					tmp += port_map_array[ip_vlan_tem[2]];						
				}
				if(ip_vlan_tem[2].length == 1)
					tmp +="-";
				tmp +="--------------";
				
				tmp += ip_vlan_tem[3];

				if(0 == overwrite_vlan)
				{
					
					cf.ip_vlan_table.options.add(new Option(tmp, ip_vlan));
					count++;
				}
				else
				{
					cf.ip_vlan_table.options[overwrite_vlan].value = ip_vlan;
					cf.ip_vlan_table.options[overwrite_vlan].innerHTML = tmp;
				}
				
			}
			
			function list_del_ip_vlan(Index)
			{
				var cf = document.forms[0];

				cf.ip_vlan_table.remove(Index);
				count--;
			}

			function delitem()
			{
				var cf = document.forms[0];
				var pos = cf.ip_vlan_table.selectedIndex;

				if(pos > 0)
				{
					list_del_ip_vlan(pos);
				}
			}

			function set_ip_vlan_port()
			{
				var cf = document.forms[0];
				var ports = cf.port_bits.value;
				var g_ports = cf.g_port_bits.value;
			 	var i = 1;
				var j = 1;
				var a = 0; 
				while(ports)
				{
					if(ports & 1)
					{
						if(g_ports & 1)		//G port
						{
							cf.ip_vlan_port_list.options.add(new Option("G" + i, a));
							i++;
						}
						else
						{
							cf.ip_vlan_port_list.options.add(new Option("XG" + j, a));	
							j++;
						}
					}						
					ports >>= 1;
					g_ports >>= 1;
					a++;
				}
			}

			function disable_all_intput()
			{
				var cf = document.forms[0];

				setDisabled(true,cf.ip_address);
				setDisabled(true,cf.ip_vlan_port_list);
				setDisabled(true,cf.ip_vlan_vid);
				setDisabled(true,cf.Add);
				setDisabled(true,cf.Delete);
				setDisabled(true,cf.Save);
				setDisabled(true,cf.Cancel);
            }
            
            function check_vlan_ip(fobj)
            {
                var tmp = fobj;
                var ip = new RegExp("^([0-9]+).([0-9]+).([0-9]+).([0-9]+)$");
                if (tmp.match(ip) == null)
                    return false;

                var ipaddr = tmp.split(".");
                tmp = "";
                if(!(ipaddr[0] >0 && ipaddr[0] <255 && ipaddr[1]>=0 && ipaddr[1]<=255 && ipaddr[2]>=0 && ipaddr[2]<=255 && ipaddr[3]>0 && ipaddr[3]<255))
                    return false;
                for(var i = 0; i < ipaddr.length; i++)
                {
                    var num = parseInt(ipaddr[i], 10);//trim the unwanted leading '0'
                    tmp += String(num);
                    if(i < ipaddr.length - 1)
                        tmp += ".";
                }
                return true;
            }

			function checkData()
			{
				var cf = document.forms[0];
				var i = 0;

				cf.h_ip_vlan.value = "";

				for(i = 1; i < cf.ip_vlan_table.options.length; i++)
				{
					cf.h_ip_vlan.value += cf.ip_vlan_table.options[i].value + ";";
				}
			}

		</script>
	</head>
<body style="margin:0" onLoad="init()">
	<form method="POST" action="setup.cgi">
		<table width="1002"  border="0" align="center" cellspacing="0">
			<tr>
				<td>
					<table width="1002" border="0" cellpadding="0" cellspacing="0" class="body">
						<tr>
							<td height="7" colspan="2" align="left" valign="top" bgcolor="#FFFFFF"></td>
						</tr>
						<tr>
                                <td id="logo" width="432"  height="67" align="left" valign="top" bgcolor="#FFFFFF" style="background-image:url(./images/logo_maiwe_en.jpg);background-repeat:no-repeat";></td>
                                <td width="570" height="67" align="right" valign="bottom"  bgcolor="#FFFFFF"><a href="./setup.cgi?todo=changeLanguage"><span id='changeLanguage' class="showbtn4">中文版</span></a><a href="./setup.cgi?todo=logout"><span class="showbtn3">Logout</span><span class="showbtn5">&times;</span></a>
								<br>
								<span class="style6">VISITOR IP：@clinet_ip# &nbsp;VISITOR MAC：@clinet_mac#</p>
							</spen></td>
						</tr>
						<tr>
							<td height="7" colspan="2" align="left"  bgcolor="#FFFFFF"></td>
						</tr>
						<tr>
							<table width="1002" >
								<script language="JavaScript1.2">init_menu();</script>  
							</table>
						</tr>
						<tr>
							<td height="7" colspan="2" align="left"  bgcolor="#FFFFFF"></td>
						</tr>
					</table>
				</td>
			</tr>
		</table>

		<table width="1002"  border="0" align="center" cellspacing="0">
			<tr>
				<td height="25" align="left" valign="middle">
					<table width="1002"  border="0" cellspacing="0">
						<tr>
							<td width="290" height="25" class="table_title"><strong class="style4">&nbsp;&nbsp;Current Page &gt;&gt;</strong><span class="style4"> Link Layer </span><strong class="style4">&gt;&gt;</strong><span class="style3">IP VLAN</span></td>
						</tr>
					</table>
				</td>
			</tr>
			<tr height="8">
				<td width="1001"><div style="overflow:hidden;background:#969594;height:1px;"></div></td></tr>
			<tr>
		</table>
		
		<table width="1002"  border="0" align="center" cellspacing="0">
			<tr>
				<td width="200" height="25" class="table_left">&nbsp;&nbsp;source IP adress</td>
				<td align="left" class="table_right">&nbsp;&nbsp;
					<input type="text" name="ip_address"/>
					<span class="table_left" id="range">&nbsp;(A.B.C.D/M)</span>
				</td>
			</tr>
			<tr>
				<td width="200" height="25" class="table_left">&nbsp;&nbsp;Port</td>
				<td align="left" class="table_right">&nbsp;&nbsp;
					<select name="ip_vlan_port_list" class="select1">
						<option value=-1>not selected</option>
					</select>
				</td>
			</tr>
			<tr>
				<td height="25" class="table_left">&nbsp;&nbsp;VID</td>
				<td  class="table_right">&nbsp;&nbsp;
					<input type="text" name="ip_vlan_vid" maxlength="4"/>
					<span class="table_left">&nbsp;(1~4094)</span>
				</td>
			</tr>
		</table>

		<table width="1002"  border="0" align="center" cellspacing="0">
			<tr align="left" valign="top">
				<td height="25" align="center" valign="top" style="padding-top:5px">
					<span style="padding-top:5px">
						<input type="button" name="Add" value="Add" class="showbtn7"  onclick="return additem()" />
						<input type="button" name="Delete" value="Delete"  class="showbtn7" onclick="return delitem()"/>
						<input type="submit" name="Save" value="Save"  class="showbtn7" onclick="return checkData()"/>
						<input type="button" name="Cancel" value="Cancel" class="showbtn7" onClick="location.href='setup.cgi?next_file=ip_vlan_en.html'">
					</span>
				</td>
			</tr>
		</table>
		
		<table width="1002"  border="0" align="center" cellspacing="0">
			<tr height="8">
				<td width="1001">
					<div style="overflow:hidden;background:#969594;height:1px;"></div>
				</td>
			</tr>
			<tr>
				<td>
					<table width="1001"  border="0" cellspacing="1" cellpadding="0">
						<tr class="table_right">
							<td colspan="7" >
								<select name="ip_vlan_table" size="25" style="width: 1001px;-webkit-appearance: none; box-shadow: none !important;margin:1px;font-size:12px;font-family:Courier New,sans-serif; color:#333333;">
									<option value="0">--SN----------------------IP address------------------------------------Port--------------VID-------------------------------------------------------------</option>
								</select>
							</td>
						</tr>
						<tr>
							<td colspan="7" height="4"><hr size="1"/></td>
						</tr>
					</table>
				</td>
			</tr>
		</table>
		<input type="hidden" name="enableEnglish" value="@enableEnglish#">
		<input type="hidden" name="cpu_port" value="@cpu_port#">
		<input type="hidden" name="port_bits" value="@port_bits#">
		<input type="hidden" name="g_port_bits" value="@g_port_bits#">

		<input type="hidden" name="h_ip_vlan" value="@h_ip_vlan#">

		<input type="hidden" name="loader" value="@loader#">
		<input type="hidden" name="todo" value="save">
		<input type="hidden" name="this_file" value="ip_vlan_en.html">
		<input type="hidden" name="next_file" value="ip_vlan_en.html">
        <input type="hidden" name="port_map" value="@port_map#">		
	</form>
</body>
</html>
